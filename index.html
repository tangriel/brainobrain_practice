<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">

  <title>Mental Math Trainer</title>

  <style>
    :root{
      --primary: #3498db;
      --primary-dark: #2980b9;
      --accent: #8e44ad;
      --success: #27ae60;
      --control-col-1: 160px;
      --control-col-2: 420px;
      --control-col-3: 160px;
      --max-page-width: 980px;
    }

    /* Page layout */
    body{
      font-family: Arial, Helvetica, sans-serif;
      max-width: var(--max-page-width);
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
      background: #fff;
      color:#222;
    }
    h1,h2 { color:#2c3e50; margin:0 0 12px 0; }
    .section{
      background:#f9f9f9;
      border-radius:10px;
      padding:18px;
      margin-bottom:20px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }

    /* Controls grid (three columns) */
    .controls{
      display:grid;
      grid-template-columns: var(--control-col-1) var(--control-col-2) var(--control-col-3);
      gap:12px;
      align-items:start;
      margin-bottom:14px;
    }
    .controls > div{ display:flex; flex-direction:column; }
    label{ font-weight:700; margin-bottom:6px; font-size:.95rem; }
    input[type="number"], select, button{
      padding:10px 12px;
      border-radius:6px;
      border:1px solid #ddd;
      font-size:1rem;
      box-sizing:border-box;
      background:#fff;
    }

    /* Make selects wide enough */
    .controls select{
      min-width: calc(var(--control-col-2) - 20px);
      max-width:100%;
      width:auto;
    }

    /* Ensure Number of Addends sits in 3rd column */
    .add-addends-wrapper{ grid-column:3; }

    /* Generate buttons span full available width (fills grey area) */
    .generate-btn-container{
      grid-column: 1 / -1;
      width: 100%; 
      display:flex;
      justify-content:center;
      margin-top:12px;
      box-sizing: border-box; 
      justify-self: stretch;
      align-self: start;
      display: block;
    }
    .generate-btn-container > button,
    .generate-btn-inline {
      display: block !important; 
      width: 100% !important; 
      max-width: 100% !important; 
      min-width: 260px;
      padding:10px 14px;
      border-radius:6px;
      background:var(--primary);
      color:#fff;
      border:0;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
      box-sizing:border-box;
    }
    .generate-btn-container > button:hover{ background:var(--primary-dark); }

    /* Inline generate buttons for arithmetic sections (fill their column) */
    .generate-btn-inline{
      display:block;
      width:100%;
      padding:10px 14px;
      border-radius:6px;
      background:var(--primary);
      color:#fff;
      border:0;
      font-weight:700;
      white-space:nowrap;
      cursor:pointer;
      box-sizing:border-box;
    }
    .generate-btn-inline:hover{ background:var(--primary-dark); }

    .show-all-btn{
      background:#f39c12; color:#fff; border:0; padding:10px 14px; border-radius:6px; font-weight:700; cursor:pointer;
    }

    .exercises{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
      gap:12px;
      margin-top:8px;
    }
    .exercise{ background:#fff; padding:12px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    .answer{ display:none; color:#c0392b; font-weight:700; }
    .show-answer-btn{ background:var(--success); color:#fff; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; margin-top:8px; }
    .eye-icon{ margin-left:6px; vertical-align:middle; }

    /* ---------- Abacus / Flashcards ---------- */
    .abacus-title{ margin-bottom:8px; }

    /* Custom small control row so label and button align */
    .abacus-controls-row{ display:flex; gap:12px; align-items:flex-end; margin-bottom:12px; flex-wrap:wrap; }
    .abacus-controls-row .field{ display:flex; flex-direction:column; }
    .abacus-controls-row .field.small{ width:160px; } /* increased so label doesn't wrap */
    .abacus-controls-row .field.medium{ width:160px; }
    .abacus-controls-row .field.flex{ flex:1 1 auto; min-width:180px; }

    .abacus-wrapper{
      display:flex;
      gap:14px;
      align-items:flex-start;
      margin-top:12px;
      flex-wrap:nowrap;
    }

    .abacus-canvas-wrap{
      flex:1 1 calc(100% - 150px);
      min-width:320px;
      box-sizing:border-box;
    }

    .abacus-controls-stack{
      flex:0 0 140px;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }

    .abacus{
      position:relative;
      border-radius:12px;
      background: linear-gradient(180deg,#e9d59a,#e4c77a);
      padding:24px 12px 40px;
      box-shadow: inset 0 6px 12px rgba(0,0,0,0.06), 0 3px 8px rgba(0,0,0,0.08);
      overflow: visible;
      min-height:480px;
    }

    .abacus-rail{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:flex-start;
      padding:8px 6px;
      position:relative;
    }

    .abacus-column{
      width:70px;
      min-width:48px;
      height:420px;
      display:flex;
      flex-direction:column;
      align-items:center;
      position:relative;
      box-sizing:border-box;
    }

    .abacus-bead{
      width:48px; height:48px; border-radius:50%;
      background:#6b3f2b; box-shadow:0 3px 0 rgba(0,0,0,0.25);
      transition: transform .22s ease, opacity .12s;
      flex-shrink:0;
      display:block;
      opacity:1;
    }
    .top-bead{ width:42px; height:42px; background:#8b4f34; box-shadow:0 2px 0 rgba(0,0,0,0.2); }
    .bottom-bead{ width:42px; height:42px; background:#6b3f2b; }

    .top-space{ height:116px; display:flex; align-items:center; justify-content:center; }
    .bottom-beads{ display:flex; flex-direction:column; gap:14px; margin-top:8px; align-items:center; }

    .abacus-beam{ width:100%; height:10px; background:#2f2f2f; margin:8px 0; border-radius:4px; position:relative; box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset; }
    .abacus-group-dot{ position:absolute; width:8px; height:8px; border-radius:50%; background:#fff; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow:0 0 0 1px rgba(255,255,255,0.08) inset; }

    .abacus-rod{ position:absolute; width:3px; top:8px; bottom:8px; left:50%; transform:translateX(-50%); background: rgba(47,47,47,0.35); border-radius:2px; z-index:1; pointer-events:none; }

    .top-bead{ transform: translateY(-56px); }
    .top-bead.active{ transform: translateY(0); }
    .bottom-bead{ transform: translateY(56px); }
    .bottom-bead.active{ transform: translateY(0); }

    /* zero columns: JS removes beads; class kept for potential styling */
    .abacus-column.zero{}

    .abacus-cover{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.995);
      display:none;
      align-items:center;
      justify-content:center;
      font-weight:700;
      z-index:120;
      border-radius:12px;
      pointer-events:auto;
      text-align:center;
    }
    .abacus-cover.show{ display:flex; }

    .abacus-controls-stack button{
      width:100% !important;
      padding:10px 12px;
      font-weight:700;
      border-radius:6px;
      border:0;
      white-space:nowrap;
      cursor:pointer;
    }
    .abacus-controls-stack .show-answer-btn{ background: var(--success); color:#fff; }
    .abacus-controls-stack .peek-btn{ background: var(--accent); color:#fff; }
    .abacus-controls-stack .peek-btn:disabled{ opacity:0.6; cursor:not-allowed; }

    .abacus-number-display{ font-size:1.15rem; font-weight:800; color:#c0392b; text-align:center; padding-top:6px; }

    /* Responsive */
    @media (max-width:980px){
      .controls{ grid-template-columns: 160px minmax(160px,1fr) 140px; }
      .controls select{ min-width:220px; }
      .abacus-wrapper{ flex-direction:column; }
      .abacus-canvas-wrap{ min-width:320px; max-width:100%; }
      .abacus-controls-stack{ width:100%; flex-direction:row; gap:12px; }
      .abacus-controls-stack button{ flex:1; }
      .abacus-rod{ display:none; }
    }

    @media (max-width:520px){
      .controls{ grid-template-columns:1fr 1fr; gap:10px; }
      .controls select{ min-width:0; width:100%; }
      .add-addends-wrapper{ grid-column:auto; margin-left:0; }
      .abacus-column{ width:48px; height:300px; }
      .top-space{ height:64px; }
      .abacus{ min-height:260px; padding-bottom:22px; }
    }
  </style>
</head>
<body>
  <h1>Mental Math Trainer</h1>

  <!-- Addition -->
  <div class="section" id="addition-section">
    <h2>Addition Exercises</h2>
    <div class="controls">
      <div>
        <label for="add-count">Number of Exercises:</label>
        <input type="number" id="add-count" min="1" max="20" value="3">
      </div>

      <div>
        <label for="add-type">Number Type:</label>
        <select id="add-type">
          <option value="sd">Single-Digit Only</option>
          <option value="dd">Double-Digit Only</option>
          <option value="mixed" selected>Single & Double-Digit Mix</option>
        </select>
      </div>

      <div class="add-addends-wrapper">
        <label for="add-addends">Number of Addends:</label>
        <div class="input-with-label">
          <input type="number" id="add-addends" min="3" max="20" value="4">
          <span>numbers</span>
        </div>
      </div>

      <div class="generate-btn-container">
        <button id="generate-add-btn" class="generate-btn-inline">Generate Addition Exercises</button>
      </div>
    </div>

    <div id="add-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-add" class="show-all-btn">Show All Answers <span class="eye-icon">üëÅÔ∏è</span></button>
    </div>
  </div>

  <!-- Multiplication -->
  <div class="section" id="multiplication-section">
    <h2>Multiplication Exercises</h2>
    <div class="controls">
      <div>
        <label for="mult-count">Number of Exercises:</label>
        <input type="number" id="mult-count" min="1" max="20" value="3">
      </div>
      <div>
        <label for="mult-type">Number Type:</label>
        <select id="mult-type">
          <option value="sd_sd">Single-Digit √ó Single-Digit</option>
          <option value="dd_sd" selected>Double-Digit √ó Single-Digit</option>
          <option value="td_sd">Triple-Digit √ó Single-Digit</option>
          <option value="dd_dd">Double-Digit √ó Double-Digit</option>
        </select>
      </div>
      <div></div>
      <div class="generate-btn-container">
        <button id="generate-mult-btn" class="generate-btn-inline">Generate Multiplication Exercises</button>
      </div>
    </div>

    <div id="mult-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-mult" class="show-all-btn">Show All Answers <span class="eye-icon">üëÅÔ∏è</span></button>
    </div>
  </div>

  <!-- Division -->
  <div class="section" id="division-section">
    <h2>Division Exercises</h2>
    <div class="controls">
      <div>
        <label for="div-count">Number of Exercises:</label>
        <input type="number" id="div-count" min="1" max="20" value="3">
      </div>
      <div>
        <label for="div-type">Number Type:</label>
        <select id="div-type">
          <option value="dd_sd" selected>Double-Digit √∑ Single-Digit</option>
          <option value="td_sd">Triple-Digit √∑ Single-Digit</option>
          <option value="fd_sd">Four-Digit √∑ Single-Digit</option>
          <option value="fd_dd">Four-Digit √∑ Double-Digit</option>
        </select>
      </div>
      <div></div>
      <div class="generate-btn-container">
        <button id="generate-div-btn" class="generate-btn-inline">Generate Division Exercises</button>
      </div>
    </div>

    <div id="div-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-div" class="show-all-btn">Show All Answers <span class="eye-icon">üëÅÔ∏è</span></button>
    </div>
  </div>

  <!-- Flashcards -->
  <div class="section abacus-section" id="abacus-section">
    <h2 class="abacus-title">Flashcards</h2>

    <div class="abacus-controls-row">
      <div class="field medium">
        <label for="abacus-digits">Digits (1‚Äì6):</label>
        <input type="number" id="abacus-digits" min="1" max="6" value="3">
      </div>

      <div class="field small">
        <label for="abacus-duration">Show for (seconds):</label>
        <input type="number" id="abacus-duration" min="1" max="10" value="5">
      </div>

      <div class="field">
        <label style="visibility:hidden; height:0; margin:0;">.</label>
        <div style="display:flex; align-items:center; gap:8px;">
          <button id="generate-abacus-btn" style="padding:10px 12px; min-width:140px; background:var(--primary); color:#fff; border-radius:6px; border:0;">Generate Flashcard</button>
        </div>
      </div>
    </div>

    <div class="abacus-wrapper">
      <div class="abacus-canvas-wrap">
        <div class="abacus" id="abacus-display" aria-live="polite">
          <div class="abacus-rail" id="abacus-rail">
            <!-- columns inserted dynamically -->
          </div>

          <div class="abacus-cover" id="abacus-cover">Memorize the beads... (hidden)</div>
        </div>
      </div>

      <div class="abacus-controls-stack" role="group" aria-label="Abacus controls">
        <button id="show-abacus-answer" class="show-answer-btn" style="white-space:nowrap;">Show Answer <span class="eye-icon">üëÅÔ∏è</span></button>
        <button id="peek-abacus-btn" class="peek-btn" style="white-space:nowrap;">Peek Again</button>
        <div class="abacus-number-display" id="abacus-number-display" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <footer style="text-align:center; color:#7f8c8d; margin-top:18px;">
    Created for mental arithmetic practice - BrainOBrain Exercises
  </footer>

  <script>
    // Utilities
    function getRandomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    // Random helpers
    function getRandomSingleDigit(){ return getRandomInt(2,9); }
    function getRandomDoubleDigit(){ return getRandomInt(11,99); }
    function getRandomTripleDigit(){ return getRandomInt(100,999); }
    function getRandomFourDigit(){ return getRandomInt(1000,9999); }

    // Addition generator
    function generateAdditionExercise(type, numAddends){
      let addends=[], runningSum=0;
      const maxNegatives = Math.floor(numAddends/3);
      let numNegatives = 0;
      if(type==='sd'){ for(let i=0;i<numAddends;i++) addends.push(getRandomSingleDigit()); }
      else if(type==='dd'){ for(let i=0;i<numAddends;i++) addends.push(getRandomDoubleDigit()); }
      else {
        const doubleDigitCount = Math.max(0, Math.min(numAddends, getRandomInt(Math.max(0,Math.floor(numAddends/2)-1), Math.floor(numAddends/2)+1)));
        let types = [];
        for(let i=0;i<numAddends;i++) types.push(i<doubleDigitCount ? 'dd' : 'sd');
        types = shuffleArray(types);
        for(let i=0;i<numAddends;i++) addends.push(types[i]==='dd' ? getRandomDoubleDigit() : getRandomSingleDigit());
      }
      addends.sort((a,b)=>Math.abs(b)-Math.abs(a));
      const finalAddends=[];
      for(const num of addends){
        let finalNum = num;
        if(numNegatives < maxNegatives && Math.random() < 0.3){
          if(runningSum > num){ finalNum = -num; numNegatives++; }
        }
        finalAddends.push(finalNum);
        runningSum += finalNum;
      }
      let best = [...finalAddends], attempts=0;
      while(attempts<10){
        attempts++; const test=[...finalAddends]; shuffleArray(test);
        let sum=0, ok=true; for(const n of test){ sum+=n; if(sum<0){ ok=false; break; } }
        if(ok){ best=test; break; }
      }
      return { addends: best, answer: best.reduce((s,n)=>s+n,0) };
    }

    function generateMultiplicationExercise(type){
      let a,b;
      switch(type){
        case 'sd_sd': a=getRandomSingleDigit(); b=getRandomSingleDigit(); break;
        case 'dd_sd': a=getRandomDoubleDigit(); b=getRandomSingleDigit(); break;
        case 'td_sd': a=getRandomTripleDigit(); b=getRandomSingleDigit(); break;
        case 'dd_dd': a=getRandomDoubleDigit(); do{ b=getRandomDoubleDigit(); } while(b===10); break;
        default: a=getRandomSingleDigit(); b=getRandomSingleDigit();
      }
      return { factors:[a,b], answer: a*b };
    }

    function generateDivisionExercise(type){
      let dividend, divisor;
      switch(type){
        case 'dd_sd':
          divisor = getRandomSingleDigit(); { const min=Math.ceil(10/divisor), max=Math.floor(99/divisor); const f=getRandomInt(min,max); dividend = divisor * f; } break;
        case 'td_sd':
          divisor = getRandomSingleDigit(); { const min=Math.ceil(100/divisor), max=Math.floor(999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; } break;
        case 'fd_sd':
          divisor = getRandomSingleDigit(); { const min=Math.ceil(1000/divisor), max=Math.floor(9999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; } break;
        case 'fd_dd':
          do{ divisor = getRandomInt(11,50); } while(divisor===10);
          { const min=Math.ceil(1000/divisor), max=Math.floor(9999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; } break;
        default:
          divisor = getRandomSingleDigit(); dividend = divisor * getRandomInt(10,99);
      }
      return { dividend, divisor, answer: dividend/divisor };
    }

    // UI creators
    function createAdditionExerciseElement(ex,index){
      const div=document.createElement('div'); div.className='exercise';
      let html=`<strong>${index}.</strong> `;
      for(let i=0;i<ex.addends.length;i++){ const n=ex.addends[i]; if(i===0) html+=n; else html+= n<0?` - ${Math.abs(n)}`:` + ${n}`; }
      html += ` = <span class="answer">${ex.answer}</span>`;
      div.innerHTML = html;
      const btn=document.createElement('button'); btn.className='show-answer-btn'; btn.innerHTML='Show Answer <span class="eye-icon">üëÅÔ∏è</span>';
      btn.onclick = ()=>{ div.querySelector('.answer').style.display='inline'; btn.style.display='none'; };
      div.appendChild(btn);
      return div;
    }

    function createMultiplicationExerciseElement(ex,index){
      const div=document.createElement('div'); div.className='exercise';
      div.innerHTML=`<strong>${index}.</strong> ${ex.factors[0]} √ó ${ex.factors[1]} = <span class="answer">${ex.answer}</span>`;
      const btn=document.createElement('button'); btn.className='show-answer-btn'; btn.innerHTML='Show Answer <span class="eye-icon">üëÅÔ∏è</span>';
      btn.onclick = ()=>{ div.querySelector('.answer').style.display='inline'; btn.style.display='none'; };
      div.appendChild(btn); return div;
    }

    function createDivisionExerciseElement(ex,index){
      const div=document.createElement('div'); div.className='exercise';
      div.innerHTML=`<strong>${index}.</strong> ${ex.dividend} √∑ ${ex.divisor} = <span class="answer">${ex.answer}</span>`;
      const btn=document.createElement('button'); btn.className='show-answer-btn'; btn.innerHTML='Show Answer <span class="eye-icon">üëÅÔ∏è</span>';
      btn.onclick = ()=>{ div.querySelector('.answer').style.display='inline'; btn.style.display='none'; };
      div.appendChild(btn); return div;
    }

    // Soroban functions
    function buildAbacusColumns(n){
      const rail=document.getElementById('abacus-rail'); if(!rail) return;
      rail.innerHTML='';
      for(let i=0;i<n;i++){
        const col=document.createElement('div'); col.className='abacus-column'; col.dataset.index=i;
        const rod=document.createElement('div'); rod.className='abacus-rod'; col.appendChild(rod);
        const topSpace=document.createElement('div'); topSpace.className='top-space'; col.appendChild(topSpace);
        const beam=document.createElement('div'); beam.className='abacus-beam';
        const indexFromRight=(n-1-i);
        if(indexFromRight%3===0){ const dot=document.createElement('div'); dot.className='abacus-group-dot'; beam.appendChild(dot); }
        col.appendChild(beam);
        const bottom=document.createElement('div'); bottom.className='bottom-beads'; col.appendChild(bottom);
        rail.appendChild(col);
      }
    }

    // Render only non-zero beads
    function setAbacusColumn(columnElement, digit){
      if(!columnElement) return;
      // remove existing beads
      const existingTop=columnElement.querySelector('.top-bead'); if(existingTop) existingTop.remove();
      const existingBottoms=Array.from(columnElement.querySelectorAll('.bottom-bead')); existingBottoms.forEach(b=>b.remove());
      columnElement.classList.remove('zero');

      if(digit===0){
        columnElement.classList.add('zero');
        return; // do not render beads
      }

      // top bead if >=5
      if(digit>=5){
        const topSpace = columnElement.querySelector('.top-space');
        const topBead = document.createElement('div');
        topBead.className='abacus-bead top-bead active';
        topBead.setAttribute('aria-hidden','true');
        topSpace.appendChild(topBead);
      }

      // bottom active count
      const bottomCount = digit % 5;
      const bottomContainer = columnElement.querySelector('.bottom-beads');
      for(let k=0;k<bottomCount;k++){
        const b=document.createElement('div'); b.className='abacus-bead bottom-bead active'; b.setAttribute('aria-hidden','true');
        bottomContainer.appendChild(b);
      }
    }

    function renderAbacusForNumber(numStr){
      const rail=document.getElementById('abacus-rail');
      const cols=Array.from(rail.querySelectorAll('.abacus-column'));
      const padded=String(numStr).padStart(cols.length,'0');
      for(let i=0;i<cols.length;i++){
        const digit=parseInt(padded[i],10);
        setAbacusColumn(cols[i], isNaN(digit)?0:digit);
      }
    }

    function generateRandomNumberWithDigits(digits){
      if(digits<=1) return String(getRandomInt(0,9));
      const min=Math.pow(10,digits-1), max=Math.pow(10,digits)-1;
      return String(getRandomInt(min,max));
    }

    // Cover timer helpers
    let abacusCoverTimer=null;
    function clearAbacusCoverTimer(){ if(abacusCoverTimer){ clearTimeout(abacusCoverTimer); abacusCoverTimer=null; } }
    function showAbacusCover(){ const c=document.getElementById('abacus-cover'); if(c) c.classList.add('show'); }
    function hideAbacusCover(){ const c=document.getElementById('abacus-cover'); if(c) c.classList.remove('show'); }

    // Event bindings
    document.getElementById('generate-add-btn').addEventListener('click', function(){
      const count=parseInt(document.getElementById('add-count').value||3,10);
      const type=document.getElementById('add-type').value;
      const addends=parseInt(document.getElementById('add-addends').value||4,10);
      const container=document.getElementById('add-exercises'); container.innerHTML='';
      for(let i=1;i<=count;i++) container.appendChild(createAdditionExerciseElement(generateAdditionExercise(type, addends), i));
    });

    document.getElementById('generate-mult-btn').addEventListener('click', function(){
      const count=parseInt(document.getElementById('mult-count').value||3,10);
      const type=document.getElementById('mult-type').value;
      const container=document.getElementById('mult-exercises'); container.innerHTML='';
      for(let i=1;i<=count;i++) container.appendChild(createMultiplicationExerciseElement(generateMultiplicationExercise(type), i));
    });

    document.getElementById('generate-div-btn').addEventListener('click', function(){
      const count=parseInt(document.getElementById('div-count').value||3,10);
      const type=document.getElementById('div-type').value;
      const container=document.getElementById('div-exercises'); container.innerHTML='';
      for(let i=1;i<=count;i++) container.appendChild(createDivisionExerciseElement(generateDivisionExercise(type), i));
    });

    document.getElementById('show-all-add').addEventListener('click', ()=>showAllAnswers('add-exercises'));
    document.getElementById('show-all-mult').addEventListener('click', ()=>showAllAnswers('mult-exercises'));
    document.getElementById('show-all-div').addEventListener('click', ()=>showAllAnswers('div-exercises'));

    function showAllAnswers(containerId){
      const c=document.getElementById(containerId);
      if(!c) return;
      c.querySelectorAll('.answer').forEach(a=>a.style.display='inline');
      c.querySelectorAll('.show-answer-btn').forEach(b=>b.style.display='none');
    }

    // Abacus generation
    document.getElementById('generate-abacus-btn').addEventListener('click', function(){
      const digits=Math.max(1,Math.min(6,parseInt(document.getElementById('abacus-digits').value||3,10)));
      const duration=Math.max(1,Math.min(10,parseInt(document.getElementById('abacus-duration').value||5,10)));
      buildAbacusColumns(digits);
      const numberStr=generateRandomNumberWithDigits(digits);
      renderAbacusForNumber(numberStr);

      const numberDisplay=document.getElementById('abacus-number-display');
      numberDisplay.textContent = numberStr;
      numberDisplay.style.visibility = 'hidden';
      numberDisplay.setAttribute('aria-hidden','true');

      document.getElementById('show-abacus-answer').style.display = 'inline-block';
      document.getElementById('peek-abacus-btn').disabled = false;

      hideAbacusCover();
      clearAbacusCoverTimer();
      abacusCoverTimer = setTimeout(()=>{ showAbacusCover(); abacusCoverTimer = null; }, duration * 1000);
    });

    document.getElementById('show-abacus-answer').addEventListener('click', function(){
      const numberDisplay=document.getElementById('abacus-number-display');
      numberDisplay.style.visibility = 'visible';
      numberDisplay.setAttribute('aria-hidden','false');
      clearAbacusCoverTimer();
      hideAbacusCover();
      this.style.display = 'none';
    });

    document.getElementById('peek-abacus-btn').addEventListener('click', function(){
      const btn=this;
      const raw=parseInt(document.getElementById('abacus-duration').value||5,10);
      const seconds=Math.max(1,Math.min(10,raw));
      clearAbacusCoverTimer();
      hideAbacusCover();
      btn.disabled = true;
      abacusCoverTimer = setTimeout(()=>{ showAbacusCover(); abacusCoverTimer=null; btn.disabled=false; }, seconds * 1000);
    });

    // Init
    document.getElementById('generate-add-btn').click();
    document.getElementById('generate-mult-btn').click();
    document.getElementById('generate-div-btn').click();

    (function initAbacus(){
      const defaultDigits=Math.max(1,Math.min(6,parseInt(document.getElementById('abacus-digits').value||3,10)));
      buildAbacusColumns(defaultDigits);
      const numberDisplay=document.getElementById('abacus-number-display');
      numberDisplay.textContent = ''.padStart(defaultDigits,'0');
      numberDisplay.style.visibility='hidden';
      hideAbacusCover();
    })();
  </script>
</body>
</html>
