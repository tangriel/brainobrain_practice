<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicons (restored) -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">

  <title>Mental Math Trainer</title>

  <style>
    /* ---------- General layout ---------- */
    :root {
      --control-col-1: 160px;
      --control-col-2: 380px; /* wide column so selects / generate abacus fit */
      --control-col-3: 160px;
      --primary: #3498db;
      --primary-dark: #2980b9;
      --success: #27ae60;
      --accent: #8e44ad;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
      background: #ffffff;
      color: #222;
    }

    h1, h2 { color: #2c3e50; margin: 0 0 12px 0; }
    .section {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* ---------- Controls / Inputs ---------- */
    .controls {
      display: grid;
      grid-template-columns: var(--control-col-1) var(--control-col-2) var(--control-col-3);
      gap: 12px;
      align-items: start;
      margin-bottom: 14px;
    }
    .controls > div { display:flex; flex-direction:column; }
    label { font-weight:700; margin-bottom:6px; font-size:0.95rem; }

    input[type="number"], select, button {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 1rem;
      box-sizing: border-box;
      background: #fff;
    }

    /* Make selects wide enough to fit longest options */
    .controls select {
      min-width: calc(var(--control-col-2) - 20px);
      max-width: 100%;
      width: auto;
    }

    /* Ensure the "Number of Addends" sits in the third grid column and does not overlap */
    .add-addends-wrapper { grid-column: 3; }

    /* Generate buttons container spans full width but centers the button; button itself won't be stretched */
    .generate-btn-container {
      grid-column: 1 / -1;
      display:flex;
      justify-content:center;
      margin-top:12px;
    }
    .generate-btn-container button {
      min-width: 220px;
      max-width: 100%;
      white-space: nowrap;
      padding: 10px 14px;
      border-radius: 6px;
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }
    .generate-btn-container button:hover { background: var(--primary-dark); }

    /* Make other section "generate" buttons also fit nicely (not full-width) */
    .section .generate-btn-inline {
      display:inline-block;
      min-width: 180px;
      padding: 10px 14px;
      border-radius:6px;
      background: var(--primary);
      color:#fff;
      border:0;
      font-weight:700;
      white-space:nowrap;
      cursor:pointer;
    }
    .section .generate-btn-inline:hover { background: var(--primary-dark); }

    /* Show-all buttons */
    .show-all-btn {
      background: #f39c12;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      font-weight:700;
      cursor:pointer;
    }

    /* Exercise grid */
    .exercises {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .exercise {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .answer { display:none; color:#c0392b; font-weight:700; }
    .show-answer-btn { background: var(--success); color:#fff; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; margin-top:8px; }
    .eye-icon { margin-left:6px; vertical-align:middle; }

    /* ---------- Abacus (Soroban) ---------- */

    /* Layout wrapper: canvas left, controls stack right */
    .abacus-wrapper {
      display:flex;
      gap: 14px;
      align-items:flex-start;
      margin-top: 12px;
      flex-wrap: nowrap;
    }

    /* Canvas area: take remaining space but never overflow the container */
    .abacus-canvas-wrap {
      flex: 1 1 calc(100% - 160px);
      min-width: 360px;   /* ensure wide enough so beads and labels fit */
      max-width: calc(100% - 160px);
      box-sizing: border-box;
    }

    /* Controls stack on the right (vertical) */
    .abacus-controls-stack {
      flex: 0 0 140px; /* narrow fixed width so canvas doesn't overlap */
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }

    /* Abacus field */
    .abacus {
      position: relative;
      border-radius: 12px;
      background: linear-gradient(180deg,#e9d59a,#e4c77a);
      padding: 22px 12px 36px; /* extra bottom padding for bead clearance */
      box-shadow: inset 0 6px 12px rgba(0,0,0,0.06), 0 3px 8px rgba(0,0,0,0.08);
      overflow: visible;
      min-height: 420px; /* increased height so beads fit vertically */
    }

    .abacus-rail {
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:flex-start;
      padding: 8px 6px;
      position:relative;
    }

    .abacus-column {
      width: 64px;
      min-width: 48px;
      height: 360px; /* taller columns so beads don't get clipped */
      display:flex;
      flex-direction:column;
      align-items:center;
      position:relative;
    }

    .abacus-bead {
      width: 44px; height:44px; border-radius:50%;
      background:#6b3f2b; box-shadow: 0 3px 0 rgba(0,0,0,0.25);
      transition: transform .22s ease, opacity .15s;
      flex-shrink:0;
      opacity: 1;
      display: block;
    }

    .top-bead { width:38px; height:38px; background:#8b4f34; box-shadow:0 2px 0 rgba(0,0,0,0.2); }
    .bottom-bead { width:38px; height:38px; background:#6b3f2b; }

    .top-space { height:96px; display:flex; align-items:center; justify-content:center; }
    .bottom-beads { display:flex; flex-direction:column; gap:14px; margin-top:8px; align-items:center; }

    .abacus-beam { width:100%; height:10px; background:#2f2f2f; margin:8px 0; border-radius:4px; position:relative; box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset; }
    .abacus-group-dot { position:absolute; width:8px; height:8px; border-radius:50%; background:#fff; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow:0 0 0 1px rgba(255,255,255,0.08) inset; }

    /* A thin vertical rod that remains visible for each column even when beads are hidden (helps read digits like 702) */
    .abacus-rod {
      position:absolute;
      width:3px;
      top:8px;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(47,47,47,0.35);
      border-radius:2px;
      z-index: 1;
      pointer-events: none;
    }

    /* Movement: top bead inactive -> up; active -> down to beam.
       bottom beads inactive -> down; active -> up to beam.
       When digit == 0 we hide beads visually (opacity 0 and pointer-events none)
       but keep column structure and the thin rod visible. */
    .top-bead { transform: translateY(-48px); }
    .top-bead.active { transform: translateY(0); }

    .bottom-bead { transform: translateY(48px); }
    .bottom-bead.active { transform: translateY(0); }

    .abacus-column.zero .abacus-bead { opacity: 0; pointer-events: none; } /* hide beads for digit 0 */

    /* Cover now fully covers the entire abacus area and is nearly opaque */
    .abacus-cover {
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.995);
      display:none;
      align-items:center;
      justify-content:center;
      font-weight:700;
      z-index:120;
      border-radius:12px;
      pointer-events:auto;
      text-align:center;
    }
    .abacus-cover.show { display:flex; }

    /* Abacus controls stack buttons */
    .abacus-controls-stack button {
      width:100% !important;
      padding:10px 12px;
      font-weight:700;
      border-radius:6px;
      border: 0;
      white-space: nowrap;
      cursor: pointer;
    }
    .abacus-controls-stack .show-answer-btn { background: var(--primary); color:#fff; }
    .abacus-controls-stack .peek-btn { background: var(--accent); color:#fff; }
    .abacus-controls-stack .peek-btn:disabled { opacity:0.6; cursor:not-allowed; }

    .abacus-number-display { font-size:1.15rem; font-weight:800; color:#c0392b; text-align:center; padding-top:6px; }

    /* ---------- Small-screen responsiveness ---------- */
    @media (max-width: 980px) {
      .controls { grid-template-columns: 160px minmax(160px,1fr) 140px; }
      .controls select { min-width: 220px; }
      .abacus-wrapper { flex-direction:column; }
      .abacus-canvas-wrap { min-width: 320px; max-width:100%; }
      .abacus-controls-stack { width:100%; flex-direction:row; gap:12px; }
      .abacus-controls-stack button { flex:1; }
      .abacus-rod { display:none; } /* keep things simpler on narrow screens */
    }
    @media (max-width: 520px) {
      .controls { grid-template-columns: 1fr 1fr; gap:10px; }
      .controls select { min-width:0; width:100%; }
      .add-addends-wrapper { grid-column: auto; margin-left:0; }
      .abacus-column { width:48px; height:260px; }
      .top-space { height:64px; }
      .abacus { min-height: 260px; padding-bottom:22px; }
    }
  </style>
</head>
<body>
  <h1>Mental Math Trainer</h1>

  <!-- Addition Section -->
  <div class="section" id="addition-section">
    <h2>Addition Exercises</h2>
    <div class="controls">
      <div>
        <label for="add-count">Number of Exercises:</label>
        <input type="number" id="add-count" min="1" max="20" value="3">
      </div>

      <div>
        <label for="add-type">Number Type:</label>
        <select id="add-type">
          <option value="sd">Single-Digit Only</option>
          <option value="dd">Double-Digit Only</option>
          <option value="mixed" selected>Single & Double-Digit Mix</option>
        </select>
      </div>

      <div class="add-addends-wrapper">
        <label for="add-addends">Number of Addends:</label>
        <div class="input-with-label">
          <input type="number" id="add-addends" min="3" max="20" value="4">
          <span>numbers</span>
        </div>
      </div>

      <div class="generate-btn-container">
        <button id="generate-add-btn" class="generate-btn-inline">Generate Addition Exercises</button>
      </div>
    </div>

    <div id="add-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-add" class="show-all-btn">Show All Answers <span class="eye-icon">👁️</span></button>
    </div>
  </div>

  <!-- Multiplication Section -->
  <div class="section" id="multiplication-section">
    <h2>Multiplication Exercises</h2>
    <div class="controls">
      <div>
        <label for="mult-count">Number of Exercises:</label>
        <input type="number" id="mult-count" min="1" max="20" value="3">
      </div>
      <div>
        <label for="mult-type">Number Type:</label>
        <select id="mult-type">
          <option value="sd_sd">Single-Digit × Single-Digit</option>
          <option value="dd_sd" selected>Double-Digit × Single-Digit</option>
          <option value="td_sd">Triple-Digit × Single-Digit</option>
          <option value="dd_dd">Double-Digit × Double-Digit</option>
        </select>
      </div>
      <div></div>
      <div class="generate-btn-container">
        <button id="generate-mult-btn" class="generate-btn-inline">Generate Multiplication Exercises</button>
      </div>
    </div>

    <div id="mult-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-mult" class="show-all-btn">Show All Answers <span class="eye-icon">👁️</span></button>
    </div>
  </div>

  <!-- Division Section -->
  <div class="section" id="division-section">
    <h2>Division Exercises</h2>
    <div class="controls">
      <div>
        <label for="div-count">Number of Exercises:</label>
        <input type="number" id="div-count" min="1" max="20" value="3">
      </div>
      <div>
        <label for="div-type">Number Type:</label>
        <select id="div-type">
          <option value="dd_sd" selected>Double-Digit ÷ Single-Digit</option>
          <option value="td_sd">Triple-Digit ÷ Single-Digit</option>
          <option value="fd_sd">Four-Digit ÷ Single-Digit</option>
          <option value="fd_dd">Four-Digit ÷ Double-Digit</option>
        </select>
      </div>
      <div></div>
      <div class="generate-btn-container">
        <button id="generate-div-btn" class="generate-btn-inline">Generate Division Exercises</button>
      </div>
    </div>

    <div id="div-exercises" class="exercises"></div>
    <div style="margin-top:10px;">
      <button id="show-all-div" class="show-all-btn">Show All Answers <span class="eye-icon">👁️</span></button>
    </div>
  </div>

  <!-- Abacus (Soroban) Section -->
  <div class="section abacus-section" id="abacus-section">
    <h2>Flashcards — Soroban (Japanese abacus)</h2>

    <div class="controls abacus-controls">
      <div>
        <label for="abacus-digits">Digits (1–6):</label>
        <input type="number" id="abacus-digits" min="1" max="6" value="3">
      </div>
      <div>
        <label for="abacus-duration">Show for (seconds):</label>
        <input type="number" id="abacus-duration" min="1" max="10" value="5"> <!-- default 5s -->
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="generate-btn-container">
          <button id="generate-abacus-btn">Generate Abacus Flashcard</button>
        </div>
      </div>
    </div>

    <div class="abacus-wrapper">
      <div class="abacus-canvas-wrap">
        <div class="abacus" id="abacus-display" aria-live="polite">
          <div class="abacus-rail" id="abacus-rail">
            <!-- columns inserted dynamically -->
          </div>

          <!-- cover placed inside abacus to cover the whole canvas -->
          <div class="abacus-cover" id="abacus-cover">Memorize the beads... (hidden)</div>
        </div>
      </div>

      <div class="abacus-controls-stack" role="group" aria-label="Abacus controls">
        <button id="show-abacus-answer" class="show-answer-btn">Show Answer <span class="eye-icon">👁️</span></button>
        <button id="peek-abacus-btn" class="peek-btn">Peek Again</button>
        <div class="abacus-number-display" id="abacus-number-display" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <footer style="text-align:center; color:#7f8c8d; margin-top:18px;">
    Created for mental arithmetic practice - BrainOBrain Exercises
  </footer>

  <script>
    // ===== Utilities =====
    function getRandomInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

    // ===== Arithmetic helpers (kept original behavior) =====
    function getRandomSingleDigit(){ return getRandomInt(2,9); }
    function getRandomDoubleDigit(){ return getRandomInt(11,99); }
    function getRandomTripleDigit(){ return getRandomInt(100,999); }
    function getRandomFourDigit(){ return getRandomInt(1000,9999); }

    function generateAdditionExercise(type, numAddends) {
      let addends = [], runningSum = 0;
      const maxNegatives = Math.floor(numAddends / 3);
      let numNegatives = 0;
      if (type === "sd") {
        for (let i=0;i<numAddends;i++) addends.push(getRandomSingleDigit());
      } else if (type === "dd") {
        for (let i=0;i<numAddends;i++) addends.push(getRandomDoubleDigit());
      } else {
        const doubleDigitCount = Math.max(0, Math.min(numAddends, getRandomInt(Math.max(0,Math.floor(numAddends/2)-1), Math.floor(numAddends/2)+1)));
        let types = [];
        for (let i=0;i<numAddends;i++) types.push(i<doubleDigitCount ? 'dd' : 'sd');
        types = shuffleArray(types);
        for (let i=0;i<numAddends;i++) addends.push(types[i]==='dd' ? getRandomDoubleDigit() : getRandomSingleDigit());
      }
      addends.sort((a,b)=>Math.abs(b)-Math.abs(a));
      const finalAddends = [];
      for (const num of addends) {
        let finalNum = num;
        if (numNegatives < maxNegatives && Math.random() < 0.3) {
          if (runningSum > num) { finalNum = -num; numNegatives++; }
        }
        finalAddends.push(finalNum);
        runningSum += finalNum;
      }
      let best = [...finalAddends];
      let attempts = 0;
      while(attempts < 10) {
        attempts++;
        const test = [...finalAddends];
        shuffleArray(test);
        let sum = 0, ok = true;
        for (const n of test) { sum += n; if (sum < 0) { ok = false; break; } }
        if (ok) { best = test; break; }
      }
      return { addends: best, answer: best.reduce((s,n)=>s+n,0) };
    }

    function generateMultiplicationExercise(type) {
      let a,b;
      switch(type) {
        case 'sd_sd': a=getRandomSingleDigit(); b=getRandomSingleDigit(); break;
        case 'dd_sd': a=getRandomDoubleDigit(); b=getRandomSingleDigit(); break;
        case 'td_sd': a=getRandomTripleDigit(); b=getRandomSingleDigit(); break;
        case 'dd_dd': a=getRandomDoubleDigit(); do { b=getRandomDoubleDigit(); } while(b===10); break;
        default: a=getRandomSingleDigit(); b=getRandomSingleDigit();
      }
      return { factors:[a,b], answer: a*b };
    }

    function generateDivisionExercise(type) {
      let dividend, divisor;
      switch(type) {
        case 'dd_sd':
          divisor = getRandomSingleDigit();
          { const min=Math.ceil(10/divisor), max=Math.floor(99/divisor); const f=getRandomInt(min,max); dividend = divisor * f; }
          break;
        case 'td_sd':
          divisor = getRandomSingleDigit();
          { const min=Math.ceil(100/divisor), max=Math.floor(999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; }
          break;
        case 'fd_sd':
          divisor = getRandomSingleDigit();
          { const min=Math.ceil(1000/divisor), max=Math.floor(9999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; }
          break;
        case 'fd_dd':
          do { divisor = getRandomInt(11,50); } while(divisor === 10);
          { const min=Math.ceil(1000/divisor), max=Math.floor(9999/divisor); const f=getRandomInt(min,max); dividend = divisor * f; }
          break;
        default:
          divisor = getRandomSingleDigit();
          dividend = divisor * getRandomInt(10,99);
      }
      return { dividend, divisor, answer: dividend / divisor };
    }

    // UI creation functions for arithmetic
    function createAdditionExerciseElement(ex, idx) {
      const div = document.createElement('div'); div.className = 'exercise';
      let html = `<strong>${idx}.</strong> `;
      for (let i=0;i<ex.addends.length;i++) {
        const n = ex.addends[i];
        if (i===0) html += n;
        else html += n < 0 ? ` - ${Math.abs(n)}` : ` + ${n}`;
      }
      html += ` = <span class="answer">${ex.answer}</span>`;
      div.innerHTML = html;
      const btn = document.createElement('button'); btn.className = 'show-answer-btn'; btn.innerHTML = 'Show Answer <span class="eye-icon">👁️</span>';
      btn.onclick = () => { div.querySelector('.answer').style.display = 'inline'; btn.style.display = 'none'; };
      div.appendChild(btn);
      return div;
    }

    function createMultiplicationExerciseElement(ex, idx){
      const div = document.createElement('div'); div.className='exercise';
      div.innerHTML = `<strong>${idx}.</strong> ${ex.factors[0]} × ${ex.factors[1]} = <span class="answer">${ex.answer}</span>`;
      const btn = document.createElement('button'); btn.className = 'show-answer-btn'; btn.innerHTML='Show Answer <span class="eye-icon">👁️</span>';
      btn.onclick = ()=>{ div.querySelector('.answer').style.display='inline'; btn.style.display='none'; };
      div.appendChild(btn);
      return div;
    }

    function createDivisionExerciseElement(ex, idx){
      const div = document.createElement('div'); div.className='exercise';
      div.innerHTML = `<strong>${idx}.</strong> ${ex.dividend} ÷ ${ex.divisor} = <span class="answer">${ex.answer}</span>`;
      const btn = document.createElement('button'); btn.className='show-answer-btn'; btn.innerHTML='Show Answer <span class="eye-icon">👁️</span>';
      btn.onclick = ()=>{ div.querySelector('.answer').style.display='inline'; btn.style.display='none'; };
      div.appendChild(btn);
      return div;
    }

    // ---------- Soroban (abacus) functions ----------

    // Build columns: add thin rod and column elements; beads hidden initially until rendered
    function buildAbacusColumns(n) {
      const rail = document.getElementById('abacus-rail');
      if (!rail) return;
      rail.innerHTML = '';
      for (let i = 0; i < n; i++) {
        const col = document.createElement('div');
        col.className = 'abacus-column';
        col.dataset.index = i;

        // thin rod (always visible to help reading columns)
        const rod = document.createElement('div');
        rod.className = 'abacus-rod';
        col.appendChild(rod);

        // top space + top bead
        const topSpace = document.createElement('div');
        topSpace.className = 'top-space';
        const topBead = document.createElement('div');
        topBead.className = 'abacus-bead top-bead';
        topBead.setAttribute('aria-hidden','true');
        topSpace.appendChild(topBead);

        // beam (separator)
        const beam = document.createElement('div');
        beam.className = 'abacus-beam';
        // grouping dot for units/thousands
        const indexFromRight = (n - 1 - i);
        if (indexFromRight % 3 === 0) {
          const dot = document.createElement('div');
          dot.className = 'abacus-group-dot';
          beam.appendChild(dot);
        }

        // bottom beads
        const bottom = document.createElement('div');
        bottom.className = 'bottom-beads';
        for (let j = 0; j < 4; j++) {
          const b = document.createElement('div');
          b.className = 'abacus-bead bottom-bead';
          b.setAttribute('aria-hidden','true');
          bottom.appendChild(b);
        }

        // append in soroban order: top -> beam -> bottom
        col.appendChild(topSpace);
        col.appendChild(beam);
        col.appendChild(bottom);

        rail.appendChild(col);
      }
    }

    // Set a column to a digit (0-9). For 0 we hide beads visually but keep the rod and structure.
    function setAbacusColumn(columnElement, digit) {
      if (!columnElement) return;
      const topBead = columnElement.querySelector('.top-bead');
      const bottomBeads = Array.from(columnElement.querySelectorAll('.bottom-bead'));

      // If digit is 0, hide beads (but keep structure)
      if (digit === 0) {
        columnElement.classList.add('zero');
        // ensure beads inactive
        topBead.classList.remove('active');
        bottomBeads.forEach(b => b.classList.remove('active'));
        return;
      } else {
        columnElement.classList.remove('zero');
      }

      // top bead active when digit >= 5
      if (digit >= 5) topBead.classList.add('active'); else topBead.classList.remove('active');

      // bottom active count = digit % 5
      const bottomActive = digit % 5;
      bottomBeads.forEach((b, idx) => {
        if (idx < bottomActive) b.classList.add('active'); else b.classList.remove('active');
      });
    }

    function renderAbacusForNumber(numStr) {
      const rail = document.getElementById('abacus-rail');
      const cols = Array.from(rail.querySelectorAll('.abacus-column'));
      const padded = String(numStr).padStart(cols.length, '0');
      for (let i = 0; i < cols.length; i++) {
        const digit = parseInt(padded[i], 10);
        setAbacusColumn(cols[i], isNaN(digit) ? 0 : digit);
      }
    }

    function generateRandomNumberWithDigits(digits) {
      if (digits <= 1) return String(getRandomInt(0,9));
      const min = Math.pow(10, digits-1), max = Math.pow(10, digits) - 1;
      return String(getRandomInt(min, max));
    }

    // Cover & timers
    let abacusCoverTimer = null;
    function clearAbacusCoverTimer(){ if (abacusCoverTimer){ clearTimeout(abacusCoverTimer); abacusCoverTimer = null; } }
    function showAbacusCover(){ const c=document.getElementById('abacus-cover'); if (c) c.classList.add('show'); }
    function hideAbacusCover(){ const c=document.getElementById('abacus-cover'); if (c) c.classList.remove('show'); }

    // ---------- Event bindings ----------

    // Arithmetic section generators
    document.getElementById('generate-add-btn').addEventListener('click', function(){
      const count = parseInt(document.getElementById('add-count').value || 3, 10);
      const type = document.getElementById('add-type').value;
      const addends = parseInt(document.getElementById('add-addends').value || 4, 10);
      const container = document.getElementById('add-exercises'); container.innerHTML = '';
      for (let i=1;i<=count;i++) container.appendChild(createAdditionExerciseElement(generateAdditionExercise(type, addends), i));
    });

    document.getElementById('generate-mult-btn').addEventListener('click', function(){
      const count = parseInt(document.getElementById('mult-count').value || 3, 10);
      const type = document.getElementById('mult-type').value;
      const container = document.getElementById('mult-exercises'); container.innerHTML = '';
      for (let i=1;i<=count;i++) container.appendChild(createMultiplicationExerciseElement(generateMultiplicationExercise(type), i));
    });

    document.getElementById('generate-div-btn').addEventListener('click', function(){
      const count = parseInt(document.getElementById('div-count').value || 3, 10);
      const type = document.getElementById('div-type').value;
      const container = document.getElementById('div-exercises'); container.innerHTML = '';
      for (let i=1;i<=count;i++) container.appendChild(createDivisionExerciseElement(generateDivisionExercise(type), i));
    });

    document.getElementById('show-all-add').addEventListener('click', ()=> showAllAnswers('add-exercises'));
    document.getElementById('show-all-mult').addEventListener('click', ()=> showAllAnswers('mult-exercises'));
    document.getElementById('show-all-div').addEventListener('click', ()=> showAllAnswers('div-exercises'));

    function showAllAnswers(containerId){
      const c = document.getElementById(containerId);
      if (!c) return;
      c.querySelectorAll('.answer').forEach(a=>a.style.display='inline');
      c.querySelectorAll('.show-answer-btn').forEach(b=>b.style.display='none');
    }

    // Abacus generation
    document.getElementById('generate-abacus-btn').addEventListener('click', function(){
      const digits = Math.max(1, Math.min(6, parseInt(document.getElementById('abacus-digits').value || 3, 10)));
      const duration = Math.max(1, Math.min(10, parseInt(document.getElementById('abacus-duration').value || 5, 10)));
      buildAbacusColumns(digits);
      const numberStr = generateRandomNumberWithDigits(digits);
      renderAbacusForNumber(numberStr);

      const numberDisplay = document.getElementById('abacus-number-display');
      numberDisplay.textContent = numberStr;
      numberDisplay.style.visibility = 'hidden';
      numberDisplay.setAttribute('aria-hidden','true');

      document.getElementById('show-abacus-answer').style.display = 'inline-block';
      document.getElementById('peek-abacus-btn').disabled = false;

      hideAbacusCover();
      clearAbacusCoverTimer();
      abacusCoverTimer = setTimeout(()=>{ showAbacusCover(); abacusCoverTimer = null; }, duration * 1000);
    });

    // Show numeric answer (button is outside cover)
    document.getElementById('show-abacus-answer').addEventListener('click', function(){
      const numberDisplay = document.getElementById('abacus-number-display');
      numberDisplay.style.visibility = 'visible';
      numberDisplay.setAttribute('aria-hidden','false');
      clearAbacusCoverTimer();
      hideAbacusCover();
      this.style.display = 'none';
    });

    // Peek Again
    document.getElementById('peek-abacus-btn').addEventListener('click', function(){
      const btn = this;
      const raw = parseInt(document.getElementById('abacus-duration').value || 5, 10);
      const seconds = Math.max(1, Math.min(10, raw));
      clearAbacusCoverTimer();
      hideAbacusCover();
      btn.disabled = true;
      abacusCoverTimer = setTimeout(()=>{ showAbacusCover(); abacusCoverTimer = null; btn.disabled = false; }, seconds * 1000);
    });

    // ---------- Initialization ----------
    document.getElementById('generate-add-btn').click();
    document.getElementById('generate-mult-btn').click();
    document.getElementById('generate-div-btn').click();

    (function initAbacus(){
      const defaultDigits = Math.max(1, Math.min(6, parseInt(document.getElementById('abacus-digits').value || 3, 10)));
      buildAbacusColumns(defaultDigits);
      const numberDisplay = document.getElementById('abacus-number-display');
      numberDisplay.textContent = ''.padStart(defaultDigits, '0');
      numberDisplay.style.visibility = 'hidden';
      hideAbacusCover();
    })();
  </script>
</body>
</html>
